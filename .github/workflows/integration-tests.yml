name: Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    container:
      image: python:3.11-slim
    
    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
          - 4510-4559:4510-4559
        env:
          SERVICES: lambda,events,stepfunctions,dynamodb,sns,apigateway,iam,ssm,eks
          DEBUG: 1
          DATA_DIR: /tmp/localstack/data
        options: >-
          --health-cmd "curl -f http://localhost:4566/health"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        apt-get update && apt-get install -y \
          curl \
          unzip \
          zip \
          docker.io \
          jq

    - name: Start Docker daemon
      run: |
        dockerd &

    - name: Set up kubectl
      run: |
        curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
        chmod +x kubectl
        mv kubectl /usr/local/bin/

    - name: Set up kind
      run: |
        curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
        chmod +x ./kind
        mv ./kind /usr/local/bin/
        kind create cluster --name sre-integration --wait 300s

    - name: Install LocalStack CLI
      run: |
        pip install localstack

    - name: Install test dependencies
      run: |
        pip install -r tests/integration/requirements-dev.txt

    - name: Create test Kubernetes resources
      run: |
        kubectl create namespace sre-test --dry-run=client -o yaml | kubectl apply -f -
        
        kubectl apply -f - <<EOF
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: checkout
          namespace: sre-test
          labels:
            app: checkout
        spec:
          replicas: 3
          selector:
            matchLabels:
              app: checkout
          template:
            metadata:
              labels:
                app: checkout
            spec:
              containers:
              - name: checkout
                image: nginx:alpine
                ports:
                - containerPort: 80
                env:
                - name: DEGRADED_MODE
                  value: "false"
                - name: ERROR_RATE
                  value: "0.0"
                - name: LATENCY_MS
                  value: "0"
        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: checkout
          namespace: sre-test
          labels:
            app: checkout
        spec:
          selector:
            app: checkout
          ports:
          - port: 80
            targetPort: 80
          type: ClusterIP
        EOF

    - name: Create AWS test resources
      env:
        AWS_DEFAULT_REGION: us-east-1
        AWS_ACCESS_KEY_ID: test
        AWS_SECRET_ACCESS_KEY: test
        AWS_ENDPOINT_URL: http://localhost:4566
      run: |
        # Wait for LocalStack to be ready
        timeout 60 bash -c 'until curl -f http://localhost:4566/health; do sleep 2; done'
        
        # Create test resources
        awslocal events create-event-bus --name test-sre-events
        awslocal dynamodb create-table \
          --table-name test-sre-incidents \
          --attribute-definitions AttributeName=incident_id,AttributeType=S AttributeName=ts,AttributeType=N \
          --key-schema AttributeName=incident_id,KeyType=HASH AttributeName=ts,KeyType=RANGE \
          --billing-mode PAY_PER_REQUEST
        awslocal sns create-topic --name test-sre-notifications
        awslocal iam create-role \
          --role-name test-lambda-role \
          --assume-role-policy-document '{
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {"Service": "lambda.amazonaws.com"},
                "Action": "sts:AssumeRole"
              }
            ]
          }'

    - name: Deploy Lambda functions
      env:
        AWS_DEFAULT_REGION: us-east-1
        AWS_ACCESS_KEY_ID: test
        AWS_SECRET_ACCESS_KEY: test
        AWS_ENDPOINT_URL: http://localhost:4566
      run: |
        # Create Lambda packages
        cd terraform/lambda/alert_ingest
        zip -r alert_ingest.zip handler.py
        
        cd ../runbook_action
        zip -r runbook_action.zip handler.py
        
        # Deploy alert_ingest Lambda
        awslocal lambda create-function \
          --function-name test-alert-ingest \
          --runtime python3.11 \
          --role arn:aws:iam::123456789012:role/test-lambda-role \
          --handler handler.lambda_handler \
         zip-file fileb://alert_ingest.zip \
          --environment Variables='{
            EVENT_BUS_NAME=test-sre-events,
            INCIDENT_TABLE=test-sre-incidents,
            RUNBOOK_ARN=arn:aws:states:us-east-1:123456789012:stateMachine:test-sre-runbook,
            SNS_TOPIC_ARN=arn:aws:sns:us-east-1:123456789012:test-sre-notifications
          }' \
          --timeout 30 || echo "Lambda might already exist"

        # Deploy runbook_action Lambda
        awslocal lambda create-function \
          --function-name test-runbook-action \
          --runtime python3.11 \
          --role arn:aws:iam::123456789012:role/test-lambda-role \
          --handler handler.lambda_handler \
          --zip-file fileb://runbook_action.zip \
          --environment Variables='{
            REGION=us-east-1,
            CLUSTER_NAME=kind-sre-integration,
            TARGET_NAMESPACE=sre-test,
            TARGET_DEPLOYMENT=checkout,
            DEGRADED_PARAM=/test/degraded_mode
          }' \
          --timeout 60 || echo "Lambda might already exist"

    - name: Create Step Functions state machine
      env:
        AWS_DEFAULT_REGION: us-east-1
        AWS_ACCESS_KEY_ID: test
        AWS_SECRET_ACCESS_KEY: test
        AWS_ENDPOINT_URL: http://localhost:4566
      run: |
        cat > state-machine-definition.json <<EOF
        {
          "Comment": "SRE Incident Response Workflow",
          "StartAt": "ExecuteRunbookAction",
          "States": {
            "ExecuteRunbookAction": {
              "Type": "Task",
              "Resource": "arn:aws:lambda:us-east-1:123456789012:function:test-runbook-action",
              "End": true,
              "Retry": [
                {
                  "ErrorEquals": ["States.All"],
                  "IntervalSeconds": 2,
                  "MaxAttempts": 3,
                  "BackoffRate": 2.0
                }
              ]
            }
          }
        }
        EOF
        
        awslocal stepfunctions create-state-machine \
          --name test-sre-runbook \
          --definition file://state-machine-definition.json \
          --role-arn arn:aws:iam::123456789012:role/test-lambda-role

    - name: Run integration tests
      env:
        AWS_DEFAULT_REGION: us-east-1
        AWS_ACCESS_KEY_ID: test
        AWS_SECRET_ACCESS_KEY: test
        AWS_ENDPOINT_URL: http://localhost:4566
      run: |
        python -m pytest tests/integration/ -v \
          --cov=terraform/lambda/alert_ingest \
          --cov=terraform/lambda/runbook_action \
          --cov-report=xml \
          --cov-report=html \
          --junitxml=test-results.xml

    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-reports
        path: |
          coverage.xml
          htmlcov/
        retention-days: 30

    - name: Publish test results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Integration Tests
        path: test-results.xml
        reporter: java-junit

    - name: Cleanup test resources
      if: always()
      env:
        AWS_DEFAULT_REGION: us-east-1
        AWS_ACCESS_KEY_ID: test
        AWS_SECRET_ACCESS_KEY: test
        AWS_ENDPOINT_URL: http://localhost:4566
      run: |
        awslocal stepfunctions delete-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:test-sre-runbook || true
        awslocal lambda delete-function --function-name test-alert-ingest || true
        awslocal lambda delete-function --function-name test-runbook-action || true
        awslocal events delete-event-bus --name test-sre-events || true
        awslocal dynamodb delete-table --table-name test-sre-incidents || true
        awslocal sns delete-topic --topic-arn arn:aws:sns:us-east-1:123456789012:test-sre-notifications || true